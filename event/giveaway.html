<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Giveaway - OneDev Entertainment</title>
<link rel="stylesheet" href="../styles.css" />
<link rel="stylesheet" href="../menu.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
<style>
.giveaway-card { margin: 60px auto; background: #111; max-width: 650px; border-radius: 18px; padding: 25px; box-shadow: 0 0 25px #000; text-align: center; }
.giveaway-image { width: 100%; border-radius: 14px; margin-bottom: 20px; }
.giveaway-title { font-size: 28px; font-weight: bold; }
.giveaway-desc { margin-top: 10px; font-size: 16px; opacity: .8; }
#timer { margin-top: 25px; font-size: 40px; font-weight: bold; letter-spacing: 2px; }
#join-btn { margin-top: 30px; padding: 12px 30px; font-size: 18px; border-radius: 10px; border: none; cursor: pointer; background:#0d6efd; color:white; }
#join-btn:disabled { background: gray; cursor:not-allowed; }
.info-line { margin-top: 20px; opacity: .7; }
#admin-panel { background: #181818; margin: 40px auto; max-width: 500px; padding: 20px; border-radius: 15px; display:none; }
#admin-panel input { padding: 10px; width: 100%; margin: 8px 0; border-radius: 6px; background:#222; color:white; border:1px solid #333; }
#save-admin { padding: 12px; margin-top: 10px; width:100%; background:#0d6efd; border:none; border-radius:8px; cursor:pointer; color:white; }
</style>
</head>
<body>

<header class="nav">
<div class="nav-inner">
<div class="brand"><div class="logo">OD</div><span class="brand-name">OneDev</span></div>
<nav id="menu" class="menu"></nav>
<button id="burger" class="burger"><span></span><span></span><span></span></button>
</div>
</header>

<div class="sidebar"><div class="sidebar-content"></div></div>
<div class="sidebar-overlay"></div>

<main>
<div class="giveaway-card">
<img id="g-image" class="giveaway-image" src="assets/default-giveaway.jpg">
<h1 id="g-title" class="giveaway-title">üéâ Giveaway Spesial OneDev</h1>
<p id="g-desc" class="giveaway-desc">Ikuti event giveaway dan menangkan hadiah menarik!</p>
<div id="timer">00:00:00</div>
<button id="join-btn">üéüÔ∏è Ikut Giveaway</button>
<div class="info-line">üë• Total Peserta: <span id="total-user">0</span></div>
</div>
</main>

<div id="admin-panel">
<h2>‚öô Admin Panel Giveaway</h2>

<label>Judul Giveaway</label>
<input id="a-title" type="text">

<label>Deskripsi Giveaway</label>
<input id="a-desc" type="text">

<label>Link Gambar Giveaway</label>
<input id="a-img" type="text">

<label>Durasi (menit)</label>
<input id="a-min" type="number">

<button id="save-admin">Simpan Semua</button>
<p id="admin-msg" style="margin-top:15px; opacity:.8"></p>
</div>

<footer class="footer">¬© 2025 OneDev Entertainment. All rights reserved.</footer>

<script src="../menu.js"></script>

<script>
const WEBHOOK = "https://discord.com/api/webhooks/1433656575918080152/d-_I9Pkr5hLJUQSCQmd6cLGRYe1Jg-4WsbYqnXZQ1-C5j1wDI6bAM21GT6r28ZZMpFJl";

function sendEmbed(title, description, color=0x5865F2, fields=[]) {
    if (!WEBHOOK.includes("http")) return;

    const payload = {
        embeds: [{
            title,
            description,
            color,
            timestamp: new Date().toISOString(),
            footer: { text: "OneDev Giveaway System" },
            fields
        }]
    };

    fetch(WEBHOOK, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(payload)
    }).catch(err => console.error("Webhook error:", err));
}

// Device identifier
async function deviceHash() {
    const info = [
        navigator.userAgent,
        navigator.language,
        screen.width + "x" + screen.height,
        Intl.DateTimeFormat().resolvedOptions().timeZone
    ].join("|");

    const enc = new TextEncoder().encode(info);
    const buffer = await crypto.subtle.digest("SHA-256", enc);

    return Array.from(new Uint8Array(buffer))
        .map(b => b.toString(16).padStart(2, "0"))
        .join("");
}

// Load giveaway data
let gw = JSON.parse(localStorage.getItem("giveaway") || "{}");

if (!gw.endTime) {
    gw = {
        title: "üéâ Giveaway Spesial OneDev",
        desc: "Ikuti event giveaway dan menangkan hadiah menarik!",
        img: "assets/default-giveaway.jpg",
        endTime: Date.now() + 10601000
    };

    localStorage.setItem("giveaway", JSON.stringify(gw));

    sendEmbed("üéâ Giveaway Dimulai!",
        `Giveaway baru dimulai!\nHadiah: **${gw.title}**`,
        0x00FF00
    );
}

document.getElementById("g-title").textContent = gw.title;
document.getElementById("g-desc").textContent = gw.desc;
document.getElementById("g-image").src = gw.img;

// Admin mode
const isAdmin = location.search.includes("admin");

if (isAdmin) {
    const p = document.getElementById("admin-panel");
    p.style.display = "block";

    document.getElementById("a-title").value = gw.title;
    document.getElementById("a-desc").value = gw.desc;
    document.getElementById("a-img").value = gw.img;
    document.getElementById("a-min").value = 10;

    document.getElementById("save-admin").onclick = () => {
        gw.title = document.getElementById("a-title").value;
        gw.desc = document.getElementById("a-desc").value;
        gw.img = document.getElementById("a-img").value;
        gw.endTime = Date.now() + parseInt(document.getElementById("a-min").value) * 60000;

        localStorage.setItem("giveaway", JSON.stringify(gw));

        sendEmbed("‚öô Giveaway Diperbarui",
            `Giveaway diperbarui!\n\nJudul: **${gw.title}**\nDurasi: ${document.getElementById("a-min").value} menit`,
            0xFFD000
        );

        document.getElementById("admin-msg").textContent = "‚úî Tersimpan!";
        setTimeout(() => location.reload(), 700);
    };
}

// Peserta
let users = JSON.parse(localStorage.getItem("gw_users") || "[]");
let devices = JSON.parse(localStorage.getItem("gw_devices") || "[]");

document.getElementById("total-user").textContent = users.length;

// Join giveaway
async function join() {
    const deviceId = await deviceHash();

    if (devices.includes(deviceId)) {
        alert("‚ö† Device ini sudah digunakan untuk mengikuti giveaway.");
        return;
    }

    let name = prompt("Masukkan nama akun kamu:");
    if (!name) return;

    users.push({ name, device: deviceId });
    devices.push(deviceId);

    localStorage.setItem("gw_users", JSON.stringify(users));
    localStorage.setItem("gw_devices", JSON.stringify(devices));

    document.getElementById("total-user").textContent = users.length;

    const btn = document.getElementById("join-btn");
    btn.textContent = "Sudah Ikut Giveaway";
    btn.disabled = true;

    alert(`üéâ Akun ${name} berhasil ikut giveaway!`);

    sendEmbed("‚úÖ Peserta Baru",
        "Peserta baru ikut giveaway!",
        0x00FFAA,
        [{ name: "Nama Peserta", value: name, inline: true }]
    );
}
document.getElementById("join-btn").onclick = join;

// Auto-disable join if already used
(async () => {
    const deviceId = await deviceHash();
    if (devices.includes(deviceId)) {
        const btn = document.getElementById("join-btn");
        btn.textContent = "Sudah Ikut Giveaway";
        btn.disabled = true;
    }
})();

// Timer + winner + auto-reset
let timerEl = document.getElementById("timer");

let interval = setInterval(() => {
    let now = Date.now();
    let diff = gw.endTime - now;

    if (diff <= 0) {
        clearInterval(interval);
        timerEl.textContent = "00:00:00";

        if (users.length === 0) {
            gw.endTime = Date.now() + 10601000;
            localStorage.setItem("giveaway", JSON.stringify(gw));

            sendEmbed("‚è∞ Giveaway Selesai", "Tidak ada peserta. Auto reset.", 0xFF0000);

            location.reload();
            return;
        }

        let winner = users[Math.floor(Math.random() * users.length)];

        sendEmbed("üèÜ Giveaway Selesai!",
            `Pemenang adalah: **${winner.name}**`,
            0x3498DB
        );

        // Kirim daftar peserta
        let pesertaFields = users.map(u => ({
            name: "Peserta",
            value: u.name,
            inline: true
        }));

        sendEmbed("üìã Daftar Peserta",
            `Total peserta: ${users.length}`,
            0xFFFF00,
            pesertaFields
        );

        // Reset
        setTimeout(() => {
            users = [];
            devices = [];

            localStorage.setItem("gw_users", JSON.stringify([]));
            localStorage.setItem("gw_devices", JSON.stringify([]));

            gw.endTime = Date.now() + 10 * 60 * 1000;
            localStorage.setItem("giveaway", JSON.stringify(gw));

            sendEmbed("üîÑ Giveaway Baru Dimulai",
                `Giveaway otomatis dimulai ulang!\nHadiah: **${gw.title}**`,
                0x00FFAA
            );

            location.reload();
        }, 5000);

        return;
    }

    let h = Math.floor(diff / 3600000);
    let m = Math.floor((diff % 3600000) / 60000);
    let s = Math.floor((diff % 60000) / 1000);

    timerEl.textContent = `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
}, 1000);
</script>

</body>
</html>