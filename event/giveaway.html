<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Giveaway - OneDev Entertainment</title>

  <!-- Styles bawaan -->
  <link rel="stylesheet" href="../styles.css" />
  <link rel="stylesheet" href="../menu.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

  <style>
    .giveaway-card {
      margin: 60px auto;
      background: #111;
      max-width: 650px;
      border-radius: 18px;
      padding: 25px;
      box-shadow: 0 0 25px #000;
      text-align: center;
    }
    .giveaway-image {
      width: 100%;
      border-radius: 14px;
      margin-bottom: 20px;
    }
    .giveaway-title {
      font-size: 28px;
      font-weight: bold;
    }
    .giveaway-desc {
      margin-top: 10px;
      font-size: 16px;
      opacity: .8;
    }
    #timer {
      margin-top: 25px;
      font-size: 40px;
      font-weight: bold;
      letter-spacing: 2px;
    }
    #join-btn {
      margin-top: 30px;
      padding: 12px 30px;
      font-size: 18px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      background:#0d6efd;
      color:white;
    }
    #join-btn:disabled {
      background: gray;
      cursor:not-allowed;
    }
    .info-line {
      margin-top: 20px;
      opacity: .7;
    }
    #admin-panel {
      background: #181818;
      margin: 40px auto;
      max-width: 500px;
      padding: 20px;
      border-radius: 15px;
      display:none;
    }
    #admin-panel input {
      padding: 10px;
      width: 100%;
      margin: 8px 0;
      border-radius: 6px;
      background:#222;
      color:white;
      border:1px solid #333;
    }
    #save-admin {
      padding: 12px;
      margin-top: 10px;
      width:100%;
      background:#0d6efd;
      border:none;
      border-radius:8px;
      cursor:pointer;
      color:white;
    }
  </style>
</head>

<body>

<!-- NAVBAR -->
<header class="nav">
  <div class="nav-inner">
    <div class="brand">
      <div class="logo">OD</div>
      <span class="brand-name">OneDev</span>
    </div>
    <nav id="menu" class="menu"></nav>
    <button id="burger" class="burger"><span></span><span></span><span></span></button>
  </div>
</header>

<div class="sidebar"><div class="sidebar-content"></div></div>
<div class="sidebar-overlay"></div>

<!-- GIVEAWAY CARD -->
<main>
  <div class="giveaway-card">
    <img id="g-image" class="giveaway-image" src="assets/default-giveaway.jpg">
    <h1 id="g-title" class="giveaway-title">üéâ Giveaway Spesial OneDev</h1>
    <p id="g-desc" class="giveaway-desc">Ikuti event giveaway dan menangkan hadiah menarik!</p>

    <div id="timer">00:00:00</div>

    <button id="join-btn">üéüÔ∏è Ikut Giveaway</button>

    <div class="info-line">üë• Total Peserta: <span id="total-user">0</span></div>
  </div>
</main>

<!-- ADMIN PANEL -->
<div id="admin-panel">
  <h2>‚öô Admin Panel Giveaway</h2>

  <label>Judul Giveaway</label>
  <input id="a-title" type="text">

  <label>Deskripsi Giveaway</label>
  <input id="a-desc" type="text">

  <label>Link Gambar Giveaway</label>
  <input id="a-img" type="text">

  <label>Durasi (menit)</label>
  <input id="a-min" type="number">

  <button id="save-admin">Simpan Semua</button>
  <p id="admin-msg" style="margin-top:15px; opacity:.8"></p>
</div>

<footer class="footer">¬© 2025 OneDev Entertainment. All rights reserved.</footer>
<script src="../menu.js"></script>

<script>
/* ========================================================
   DISCORD WEBHOOK + EMBED + BUTTON
======================================================== */
const WEBHOOK = "YOUR_WEBHOOK_URL_HERE"; // GANTI

function sendEmbed(title, description, color = 0x5865F2, buttons = []) {
  if (!WEBHOOK.includes("http")) return;

  const components = buttons.length > 0 ? [
    { type: 1, components: buttons }
  ] : [];

  fetch(WEBHOOK, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      embeds: [{
        title: title,
        description: description,
        color: color,
        timestamp: new Date().toISOString(),
        footer: { text: "OneDev Giveaway System" }
      }],
      components: components
    })
  });
}

/* ========================================================
   LOAD GIVEAWAY DATA
======================================================== */
let gw = JSON.parse(localStorage.getItem("giveaway") || "{}");

if (!gw.endTime) {
  gw = {
    title: "üéâ Giveaway Spesial OneDev",
    desc: "Ikuti event giveaway dan menangkan hadiah menarik!",
    img: "assets/default-giveaway.jpg",
    endTime: Date.now() + 10 * 60 * 1000
  };
  localStorage.setItem("giveaway", JSON.stringify(gw));

  sendEmbed(
    "üéâ Giveaway Dimulai!",
    `Giveaway baru dimulai!\nHadiah: **${gw.title}**\nKlik tombol untuk ikut.`,
    0x00FF00,
    [
      {
        type: 2,
        style: 5,
        label: "Ikut Giveaway",
        url: window.location.href
      }
    ]
  );
}

document.getElementById("g-title").textContent = gw.title;
document.getElementById("g-desc").textContent = gw.desc;
document.getElementById("g-image").src = gw.img;

/* ========================================================
   ADMIN MODE
======================================================== */
const isAdmin = location.search.includes("admin");

if (isAdmin) {
  const p = document.getElementById("admin-panel");
  p.style.display = "block";

  document.getElementById("a-title").value = gw.title;
  document.getElementById("a-desc").value = gw.desc;
  document.getElementById("a-img").value = gw.img;
  document.getElementById("a-min").value = 10;

  document.getElementById("save-admin").onclick = () => {
    gw.title = document.getElementById("a-title").value;
    gw.desc = document.getElementById("a-desc").value;
    gw.img = document.getElementById("a-img").value;
    gw.endTime = Date.now() + parseInt(document.getElementById("a-min").value) * 60 * 1000;

    localStorage.setItem("giveaway", JSON.stringify(gw));

    sendEmbed(
      "‚öô Giveaway Diperbarui",
      `Giveaway berhasil diperbarui!\n\nJudul: **${gw.title}**\nDurasi baru: ${document.getElementById("a-min").value} menit`,
      0xFFD000,
      [
        {
          type: 2,
          style: 5,
          label: "Lihat Giveaway",
          url: window.location.href.replace("?admin","")
        }
      ]
    );

    document.getElementById("admin-msg").textContent = "‚úî Tersimpan!";
    setTimeout(() => location.reload(), 700);
  };
}

/* ========================================================
   DEVICE FINGERPRINT (Anti Ikut 2x)
======================================================== */
async function deviceHash() {
  const info = [
    navigator.userAgent,
    navigator.language,
    screen.width + "x" + screen.height,
    Intl.DateTimeFormat().resolvedOptions().timeZone
  ].join("|");

  const enc = new TextEncoder().encode(info);
  const hashBuffer = await crypto.subtle.digest("SHA-256", enc);

  return Array.from(new Uint8Array(hashBuffer))
    .map(b => b.toString(16).padStart(2, "0"))
    .join("");
}

/* ========================================================
   PESERTA ‚Äì 1x JOIN PER DEVICE
======================================================== */
let users = JSON.parse(localStorage.getItem("gw_users") || "[]");
let devices = JSON.parse(localStorage.getItem("gw_devices") || "[]");

document.getElementById("total-user").textContent = users.length;

async function join() {
  const deviceId = await deviceHash();

  if (devices.includes(deviceId)) {
    alert("‚ö† Kamu sudah ikut giveaway dari device ini.");
    return;
  }

  let name = prompt("Masukkan nama kamu:");
  if (!name) return;

  if (users.includes(name)) {
    alert("‚ö† Nama ini sudah pernah ikut.");
    return;
  }

  users.push(name);
  devices.push(deviceId);

  localStorage.setItem("gw_users", JSON.stringify(users));
  localStorage.setItem("gw_devices", JSON.stringify(devices));

  document.getElementById("total-user").textContent = users.length;

  const btn = document.getElementById("join-btn");
  btn.textContent = "Sudah Ikut Giveaway";
  btn.disabled = true;

  alert("üéâ Kamu berhasil ikut giveaway!");
}

document.getElementById("join-btn").onclick = join;

/* ========================================================
   AUTO LOCK BUTTON JIKA SUDAH JOIN
======================================================== */
(async () => {
  const deviceId = await deviceHash();
  if (devices.includes(deviceId)) {
    const btn = document.getElementById("join-btn");
    btn.textContent = "Sudah Ikut Giveaway";
    btn.disabled = true;
  }
})();

/* ========================================================
   TIMER + AUTO WINNER
======================================================== */
let timerEl = document.getElementById("timer");

let t = setInterval(() => {
  let now = Date.now();
  let diff = gw.endTime - now;

  if (diff <= 0) {
    clearInterval(t);
    timerEl.textContent = "00:00:00";

    if (users.length === 0) {
      sendEmbed(
        "‚è∞ Giveaway Selesai",
        "Giveaway berakhir namun tidak ada peserta.",
        0xFF0000,
        [
          { type: 2, style: 5, label: "Buat Baru", url: window.location.href + "?admin" }
        ]
      );
      return;
    }

    let winner = users[Math.floor(Math.random() * users.length)];

    sendEmbed(
      "üéâ Giveaway Selesai!",
      `Pemenang adalah:\n\nüèÖ **${winner}**\nSelamat!`,
      0x3498DB,
      [
        { type: 2, style: 5, label: "Lihat Giveaway", url: window.location.href }
      ]
    );

    return;
  }

  let h = Math.floor(diff / 3600000);
  let m = Math.floor((diff % 3600000) / 60000);
  let s = Math.floor((diff % 60000) / 1000);

  timerEl.textContent =
    String(h).padStart(2,"0") + ":" +
    String(m).padStart(2,"0") + ":" +
    String(s).padStart(2,"0");

}, 1000);
</script>

</body>
</html>